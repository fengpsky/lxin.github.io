
<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>ovs datapath模块的实现</title>
    
    <meta name="author" content="Xin Long">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/css/syntax.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/css/style_logo.css" rel="stylesheet" type="text/css" media="all">

    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <script type="text/javascript" src="/assets/js/jquery.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.flexslider.js"></script>
    
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/assets/images/linux.ico">
    <!-- Update these with your own images
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
    
  </head>

  <body style="background: #333 url(/assets/images/bg.jpg) repeat top left;">
    <!--
    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    @@@;;;;;;;;@@@@@@@@@@@;;;;;;;;@@@@@@@@@@@;;;;;;;;@@@@@@@@@@@@@;;;;;;;;@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;;;;;;;;;;;;;;;;;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;;;;;;;;;;;;;;;;;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;;;;;;;;;;;;;;;;;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@;;;;@@@@@@@@@@@@@@@@@;;;;@@@@@@@@
    @@@@@;;;;@@@@@@@@@@@@@@@;;;;@@@@@@@@@@@;;;;;@@@@@@@@@@@@@@@@;;;;;@@@@@@@@@
    @@@;;;;;;;;@@@@@@@@@@@;;;;;;;;@@@@;;;;;;;@@@@@@@@@@@@@@;;;;;;;@@@@@@@@@@@@
    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    -->
    <!--[if lt IE 8]>
	<div style='border:1px solid #F7941D;background:#FEEFDA;text-align:center;clear:both;height:75px;position:relative;'>
		<div style='position:absolute;right:3px;top:3px;font-family:courier new;font-weight:bold;'>
			<a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none";return false;'>
				<img src='http://www.ie6nomore.com/files/theme/ie6nomore-cornerx.jpg' style='border:none;' alt='Close this notice'/>
			</a>
		</div>
		<div style='width:640px;margin:0 auto;text-align:left;padding:0;overflow:hidden;color:black;'>
			<div style='width:75px;float:left;'>
				<img src='http://www.ie6nomore.com/files/theme/ie6nomore-warning.jpg' alt='Warning!'/>
			</div>
			<div style='width:275px;float:left;font-family:Arial,sans-serif;'>
				<div style='font-size:14px;font-weight:bold;margin-top:12px;'>You are using an outdated browser</div>
				<div style='font-size:12px;margin-top:6px;line-height:12px;'>
					For a better experience using this site, please upgrade to a modern web browser.
				</div>
			</div>
			<div style='width:75px;float:left;'>
				<a href='http://www.firefox.com' target='_blank'>
					<img src='http://www.ie6nomore.com/files/theme/ie6nomore-firefox.jpg' style='border:none;' alt='Get Firefox 3.5'/>
				</a>
			</div>
			<div style='width:75px;float:left;'>
				<a href='http://www.browserforthebetter.com/download.html' target='_blank'>
					<img src='http://www.ie6nomore.com/files/theme/ie6nomore-ie8.jpg' style='border:none;' alt='Get IE 8'/>
				</a>
			</div>
			<div style='width:73px;float:left;'>
				<a href='http://www.apple.com/safari/download/' target='_blank'>
					<img src='http://www.ie6nomore.com/files/theme/ie6nomore-safari.jpg' style='border:none;' alt='Get Safari 4'/>
				</a>
			</div>
			<div style='float:left;'>
				<a href='http://www.google.com/chrome' target='_blank'>
					<img src='http://www.ie6nomore.com/files/theme/ie6nomore-chrome.jpg' style='border:none;' alt='Get Google Chrome'/>
				</a>
			</div>
		</div>
	</div>
<![endif]-->


    <div class="navbar" id="top-navbar">
      <div class="navbar-inner" style="">
        <div class="container">
          <a class="brand" href="/">Xin Long</a>
          <ul class="nav">
            
            
            


  
    
  
    
    	
    	<li><a href="/pages/pages.html">页面</a></li>
    	
    
  
    
    	
    	<li><a href="/pages/message.html">留言</a></li>
    	
    
  
    
    	
    	<li><a href="/pages/about.html">关于</a></li>
    	
    
  
    
    	
    	<li><a href="/pages/tags.html">标签</a></li>
    	
    
  
    
    	
    	<li><a href="/pages/picture.html">相册</a></li>
    	
    
  
    
  
    
  
    
    	
    	<li><a href="/pages/categories.html">分类</a></li>
    	
    
  
    
  
    
    	
    	<li><a href="/pages/tools.html">Wiki</a></li>
    	
    
  
    
  
    
  
    
  
    
    	
    	<li><a href="/pages/archive.html">归档</a></li>
    	
    
  
    
  
    
  



          </ul>
          <ul class="nav subscription pull-right" data-subscription="rss">
            <li>
              <a href="/atom.xml" rel="nofollow" title="subscribe via RSS">RSS</a>
            </li>
          </ul>
          <form class="navbar-search pull-right" method="get" action="http://www.google.com/search" target="google_window">
            <label for="g_search" class="hidden"></label>
            <input id="g_search" type="text" class="search-query" placeholder="Search..." name="q" />
            <input type="submit" name=”btnG” style="display:none" id="searchsubmit" value="Search" />
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="hidden" name="oe" value="UTF-8" />
            <input type="hidden" name="hl" value="zh-CN" />
            <input type="hidden" name="domains" value="http://lxin.org" />
            <input type="hidden" name="sitesearch" value="http://lxin.org" />
          </form>
        </div>
      </div>
    </div>

    <div class="container">

      <div id="main-content" class="content">
        
<div class="page-header">
    <h1>ovs datapath模块的实现 <small><!--Supporting tagline--></small></h1>
</div>

<div class="row">
  <div id="article_indent" class="span9 pull-left">
    <div class="span3 article_published">发表于
      <span class="date">06 April 2014</span>
      <div class="article_gplus"><div class="g-plusone" data-size="small" data-annotation="none"></div></div>
    </div>
    <div class="clear"></div>
    
      
<blockquote>
  <p>datapath是openvswitch在内核中的一个模块，是openvswitch的核心，openvswitch还有两用户态的模块，就是ovs-vswitchd和ovsdb-server,但是datapath似乎是很独立的，只要通过netlink给它配置，就能很好地工作.这个模块网上介绍的不是很多，　也不详细，就很奇怪，今天看完后才明白，代码写得太漂亮了，写文字给别人介绍可能还显得多余，　这里，我也只是作个笔记。　另外的两个用户态模块，　有空了也会分析,完整地理解下openflow在kernel中的实现.</p>
</blockquote>

<h3 id="section">几个关键的结构体</h3>

<h4 id="struct-datapath">struct datapath</h4>

<pre><code>struct datapath {
        struct rcu_head rcu;
        struct list_head list_node; //把自己和其它的datapath实例也连接起来

        /* Flow table. */
        struct flow_table table; //action前要查的流表

        /* Switch ports. */
        struct hlist_head *ports; //存放vport的hash

        /* Stats. */
        struct dp_stats_percpu __percpu *stats_percpu;

#ifdef CONFIG_NET_NS
        /* Network namespace ref. */
        struct net *net;
#endif

        u32 user_features;
};
</code></pre>

<p>相当于bridge.ko中的net_bridge, 不同要清晰得多.</p>

<h4 id="struct-vport">struct vport</h4>

<pre><code>/**
 * struct vport - one port within a datapath
 * @rcu: RCU callback head for deferred destruction.
 * @dp: Datapath to which this port belongs.
 * @upcall_portid: The Netlink port to use for packets received on this port that
 * miss the flow table.
 * @port_no: Index into @dp's @ports array.
 * @hash_node: Element in @dev_table hash table in vport.c.
 * @dp_hash_node: Element in @datapath-&gt;ports hash table in datapath.c.
 * @ops: Class structure.
 * @percpu_stats: Points to per-CPU statistics used and maintained by vport
 * @stats_lock: Protects @err_stats;
 * @err_stats: Points to error statistics used and maintained by vport
 */
struct vport {
        struct rcu_head rcu;
        struct datapath *dp;
        u32 upcall_portid;
        u16 port_no;

        struct hlist_node hash_node;
        struct hlist_node dp_hash_node;
        const struct vport_ops *ops;

        struct pcpu_sw_netstats __percpu *percpu_stats;

        spinlock_t stats_lock;
        struct vport_err_stats err_stats;
};

struct vport_parms {
        const char *name;
        enum ovs_vport_type type;
        struct nlattr *options;

        /* For ovs_vport_alloc(). */
        struct datapath *dp;
        u16 port_no;
        u32 upcall_portid;
};
</code></pre>

<p>相当于bridge.ko中的net_bridge_port, 代表一个虚拟端口， 注释上面也有了</p>

<h4 id="struct-vportops">struct vport_ops</h4>

<p>这个端口操作， 对于不同的类型的端口就是不同的实例， 由一个全局一变量来管理:</p>

<pre><code>static const struct vport_ops *vport_ops_list[] = {
        &amp;ovs_netdev_vport_ops,
        &amp;ovs_internal_vport_ops,

#ifdef CONFIG_OPENVSWITCH_GRE
        &amp;ovs_gre_vport_ops,
#endif
#ifdef CONFIG_OPENVSWITCH_VXLAN
        &amp;ovs_vxlan_vport_ops,
#endif
};
</code></pre>

<h4 id="struct-ovsnet">struct ovs_net</h4>

<pre><code>struct ovs_net {
        struct list_head dps;
        struct work_struct dp_notify_work;
        struct vport_net vport_net;
};
</code></pre>

<p>不用解释，看看每个ns里都有什么全局信息</p>

<h4 id="flowtable">flow_table</h4>

<pre><code>struct table_instance {
        struct flex_array *buckets;
        unsigned int n_buckets;
        struct rcu_head rcu;
        int node_ver;
        u32 hash_seed;
        bool keep_flows;
};

struct flow_table {
        struct table_instance __rcu *ti;
        struct list_head mask_list;
        unsigned long last_rehash;
        unsigned int count;
};
</code></pre>

<p>每个datapath对应一个的流表，也就相当于bridge.ko中的net_bridge_fdb_entry.</p>

<h4 id="struct-swflow">struct sw_flow</h4>

<pre><code>struct sw_flow {
        struct rcu_head rcu;
        struct hlist_node hash_node[2];
        u32 hash;

        struct sw_flow_key key;
        struct sw_flow_key unmasked_key;
        struct sw_flow_mask *mask;
        struct sw_flow_actions __rcu *sf_acts;
        struct sw_flow_stats stats;
};
</code></pre>

<p>转发时用来保存flow信息在skb cb当中</p>

<h3 id="section-1">初始化</h3>

<h4 id="section-2">注册模块</h4>

<p>dp_init()中</p>

<ol>
  <li>
    <p>ovs_flow_init()流表初始化, flow_cache, 全局cache流表的创建</p>
  </li>
  <li>
    <p>ovs_vport_init()端口初始化, dev_table, 全局hash表的初始化</p>
  </li>
  <li>
    <p>register_pernet_device(&amp;ovs_net_ops)每名字空间操作注册, ovs_init_net()主要完成对每名字空间变量里dps和dp_notify_work的初始化</p>
  </li>
  <li>
    <p>通知链注册,内核框架</p>
  </li>
  <li>
    <p>dp_register_genl()：</p>

    <pre><code> for (i = 0; i &lt; ARRAY_SIZE(dp_genl_families); i++) {
         const struct genl_family_and_ops *f = &amp;dp_genl_families[i];

         f-&gt;family-&gt;ops = f-&gt;ops;
         f-&gt;family-&gt;n_ops = f-&gt;n_ops;
         f-&gt;family-&gt;mcgrps = f-&gt;group;
         f-&gt;family-&gt;n_mcgrps = f-&gt;group ? 1 : 0;
         err = genl_register_family(f-&gt;family);
         if (err)
                 goto error;
         n_registered++;
 }
</code></pre>

    <p>这个函数重要，通过genetic框架注册了datapath, vport, flow, packet四类与用户空间来交互操作的接口:</p>

    <pre><code> static const struct genl_family_and_ops dp_genl_families[] = {
         { &amp;dp_datapath_genl_family,
           dp_datapath_genl_ops, ARRAY_SIZE(dp_datapath_genl_ops),
           &amp;ovs_dp_datapath_multicast_group },
         { &amp;dp_vport_genl_family,
           dp_vport_genl_ops, ARRAY_SIZE(dp_vport_genl_ops),
           &amp;ovs_dp_vport_multicast_group },
         { &amp;dp_flow_genl_family,
           dp_flow_genl_ops, ARRAY_SIZE(dp_flow_genl_ops),
           &amp;ovs_dp_flow_multicast_group },
         { &amp;dp_packet_genl_family,
           dp_packet_genl_ops, ARRAY_SIZE(dp_packet_genl_ops),
           NULL },
 };
</code></pre>

    <p>具体的见其它genl框架的分析</p>
  </li>
</ol>

<h3 id="section-3">创建</h3>

<h4 id="datapath">datapath</h4>

<p>ovs_dp_cmd_new():</p>

<pre><code>    static const struct genl_ops dp_datapath_genl_ops[] = {
            { .cmd = OVS_DP_CMD_NEW,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = datapath_policy,
              .doit = ovs_dp_cmd_new
            },
            { .cmd = OVS_DP_CMD_DEL,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = datapath_policy,
              .doit = ovs_dp_cmd_del
            },
            { .cmd = OVS_DP_CMD_GET,
              .flags = 0,               /* OK for unprivileged users. */
              .policy = datapath_policy,
              .doit = ovs_dp_cmd_get,
              .dumpit = ovs_dp_cmd_dump
            },
            { .cmd = OVS_DP_CMD_SET,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = datapath_policy,
              .doit = ovs_dp_cmd_set,
            },
    };
</code></pre>

<ol>
  <li>
    <p>申请dp,</p>
  </li>
  <li>
    <p>在ovs_flow_tbl_init(&amp;dp-&gt;table)中申请flow_table</p>
  </li>
  <li>
    <p>申请dp-&gt;ports hash结构</p>
  </li>
  <li>
    <p>并调用vport = new_vport(&amp;parms);创建一个internal类型的vport, params为struct vport_parms parms类型，用来描述一个vport.</p>
  </li>
  <li>
    <p>构建一个notify信息， 发出去。</p>
  </li>
</ol>

<h3 id="vport">vport</h3>

<p>ovs_vport_cmd_new():</p>

<pre><code>    static const struct genl_ops dp_vport_genl_ops[] = {
            { .cmd = OVS_VPORT_CMD_NEW,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = vport_policy,
              .doit = ovs_vport_cmd_new
            },
            { .cmd = OVS_VPORT_CMD_DEL,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = vport_policy,
              .doit = ovs_vport_cmd_del
            },
            { .cmd = OVS_VPORT_CMD_GET,
              .flags = 0,               /* OK for unprivileged users. */
              .policy = vport_policy,
              .doit = ovs_vport_cmd_get,
              .dumpit = ovs_vport_cmd_dump
            },
            { .cmd = OVS_VPORT_CMD_SET,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = vport_policy,
              .doit = ovs_vport_cmd_set,
            },
    };
</code></pre>

<ol>
  <li>
    <p>通过dp_ifindex找到dp,然后利用struct params组织vport信息。</p>
  </li>
  <li>
    <p>通过new_vport创建并添加进dp</p>
  </li>
  <li>
    <p>调用ovs_vport_add创建, 在这个函数中， 会调用相应的create函数，如vxlan就是vxlan_tnl_create:</p>

    <pre><code> const struct vport_ops ovs_vxlan_vport_ops = {
         .type           = OVS_VPORT_TYPE_VXLAN,
         .create         = vxlan_tnl_create,
         .destroy        = vxlan_tnl_destroy,
         .get_name       = vxlan_get_name,
         .get_options    = vxlan_get_options,
         .send           = vxlan_tnl_send,
 };
</code></pre>

    <p>在vxlan_tnl_create中会调用先申请一个vport和vxlan_port， 这两个的关系vxlan_port=net_priv(vport).</p>
  </li>
  <li>
    <p>然后再申请vs, 调用我们前面分析过的vxlan_sock_add(), 再与vxlan_port关联, vxlan_port-&gt;vs = vs;</p>

    <p>可以看出来的是， 这个过程中间，对于vxlan设备来讲没有产生任何net_device，因些ifconfig -a 也就不会看到，有的也只是一个vport, 尽管中间抽取了一些vxlan源接口</p>
  </li>
  <li>
    <p>最后就是加入到dp中， 并发送notify信息</p>
  </li>
</ol>

<h4 id="flowtable-1">flow_table</h4>

<p>ovs_flow_cmd_new_or_set():</p>

<pre><code>    static const struct genl_ops dp_flow_genl_ops[] = {
            { .cmd = OVS_FLOW_CMD_NEW,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = flow_policy,
              .doit = ovs_flow_cmd_new_or_set
            },
            { .cmd = OVS_FLOW_CMD_DEL,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = flow_policy,
              .doit = ovs_flow_cmd_del
            },
            { .cmd = OVS_FLOW_CMD_GET,
              .flags = 0,               /* OK for unprivileged users. */
              .policy = flow_policy,
              .doit = ovs_flow_cmd_get,
              .dumpit = ovs_flow_cmd_dump
            },
            { .cmd = OVS_FLOW_CMD_SET,
              .flags = GENL_ADMIN_PERM, /* Requires CAP_NET_ADMIN privilege. */
              .policy = flow_policy,
              .doit = ovs_flow_cmd_new_or_set,
            },
    };
</code></pre>

<p>这个由于与vxlan关系不大，以后再写</p>

<h3 id="section-4">接收</h3>

<h4 id="netdev">net_dev</h4>

<ol>
  <li>
    <p>从栈议栈中的netif_receive_skb开始吧，这个函数中会调用dev-&gt;rx_hander, 如果一个设备被加进了datapath, 那么为!NULL, 当作一个net_dev的设备添加进datapath, 就为netdev_frame_hook</p>
  </li>
  <li>
    <p>接着获取vport = ovs_netdev_get_vport(skb-&gt;dev); 调用netdev_port_receive(), 再调用ovs_vport_receive(),</p>
  </li>
  <li>
    <p>接着再调用ovs_dp_process_received_packet(), 这个函数才是真正接收到后进行处理的函数</p>

    <pre><code> error = ovs_flow_extract(skb, p-&gt;port_no, &amp;key);
 if (unlikely(error)) {
         kfree_skb(skb);
         return;
 }

 /* Look up flow. */
 flow = ovs_flow_tbl_lookup_stats(&amp;dp-&gt;table, &amp;key, &amp;n_mask_hit);
 if (unlikely(!flow)) {
         struct dp_upcall_info upcall;

         upcall.cmd = OVS_PACKET_CMD_MISS;
         upcall.key = &amp;key;
         upcall.userdata = NULL;
         upcall.portid = p-&gt;upcall_portid;
         ovs_dp_upcall(dp, skb, &amp;upcall);
         consume_skb(skb);
         stats_counter = &amp;stats-&gt;n_missed;
         goto out;
 }

 OVS_CB(skb)-&gt;flow = flow;
 OVS_CB(skb)-&gt;pkt_key = &amp;key;

 ovs_flow_stats_update(OVS_CB(skb)-&gt;flow, skb);
 ovs_execute_actions(dp, skb);
</code></pre>

    <p>拿到流信息，更新进skb中的cb上，再在ovs_execute_actions中执行, 其中ovs_flow_extract是一个重要函数，在它里面对skb进行了解包分析</p>
  </li>
  <li>
    <p>ovs_execute_actions中， 拿到struct sw_flow_actions *acts = rcu_dereference(OVS_CB(skb)-&gt;flow-&gt;sf_acts);再调用do_execute_actions(), 在这个函数中，进行转发：</p>

    <pre><code> for (a = attr, rem = len; rem &gt; 0;
      a = nla_next(a, &amp;rem)) {
         int err = 0;

         if (prev_port != -1) {
                 do_output(dp, skb_clone(skb, GFP_ATOMIC), prev_port);
                 prev_port = -1;
         }

         switch (nla_type(a)) {
         case OVS_ACTION_ATTR_OUTPUT:
                 prev_port = nla_get_u32(a);
                 break;
</code></pre>

    <p>do_output是最终的调用,进入到这个函数中你就看到， 通过port_no查端口，而port_no应该就是在ovs_flow_tbl_lookup_stats()中拿到，还没来得及看， 并且ovs_vport_send发送了。</p>
  </li>
</ol>

<h4 id="vxlan">vxlan</h4>

<p>你会经常看到在ovs中， 有vport，但没有对应的net_device, 像添加vxlan类型设备时，它的接收自然也就不会靠rx_handler了， 对于vxlan, 很显然，有一个监听着的sock,过来的包自然找得到， 通过以前的分析，知道vxlan sock的从udp来看接收包函数为vxlan_udp_encap_recv, 最终为vs-&gt;rcv, 即vxlan_rcv,当然名字相同，但声明了static, 在ovs中另有定义，
1. 在vxlan_rcv中， 会调用ovs_vport_receive(),回到上述的第三步</p>

<h3 id="section-5">发送</h3>

<p>其实就是转发， 接do_output后的ovs_vport_send()</p>

<ol>
  <li>
    <p>vport-&gt;ops-&gt;send(vport, skb); 又回到了vport_ops, 接口自己实现， vxlan当初注册的是vxlan_tnl_send()</p>
  </li>
  <li>
    <p>打开这个函数后，你会发现它酷似当年在vxlan.ko中看到的vxlan_rcv,本来嘛，就是接口的抽取，就不要感到奇怪了,不过它直接调用的是vxlan_xmit_skb,所以得做vxlan_xmit_one的工作.</p>
  </li>
</ol>

<p>另外不知道有没有发现， 这种模式下vxlan没有fdb的学习接口， 想想为什么？ 想想配置时两者的区别就有了答案</p>

<p>大概看了下， 其它gre与vxlan在vxlan的实现很相似， 所以包括配置也很想像，可谓异曲同工.</p>

    
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/linux%20kernel/2014/04/05/vxlan-implementation" title="vxlan的内核实现">&larr; Previous</a></li>
      
        <li><a href="/pages/archive.html">Archive</a></li>
      
        <li class="next"><a href="/linux%20kernel/2014/04/07/linux-vxlan-configure" title="linux vxlan的使用">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'lxin'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>



  </div>

  <div class="span3 pull-right">
    <ul class="nav nav-list">
      <li class="nav-header">分类</li>
      
       
        
        <li>
        
        <a href="/pages/categories.html#linux tool-ref">linux tool <span>3</span></a>
        </li>
       
        
        <li class="active">
        
        <a href="/pages/categories.html#linux kernel-ref">linux kernel <span>6</span></a>
        </li>
      
      
        <li class="nav-header">Tags</li>
        
        


  
     
    	<li><a href="/pages/tags.html#kernel-ref">kernel <span>6</span></a></li>
    
  



      
    </ul>
  </div>
</div>

<!-- Gplus -->
<script type="text/javascript">
  window.___gcfg = {lang: 'zh-CN'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>



      </div>

      <footer>
        <p>&copy; Xin Long 2014 
          with help from Jijing Huang
        </p>
      </footer>

    </div> <!-- /container -->

    
    <script type="text/javascript" src="/assets/js/sd.js"></script>
  </body>
</html>

